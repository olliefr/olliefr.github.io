<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Binomial Pricing Trees in R</title>
  <meta name="description" content="This is not yet another tutorial on binomial trees. I expect my reader to be familiar with them already. If not, an article by Goddard Consulting is rather r...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://www.frolovs.me/2016/05/26/binomial-pricing-trees-in-R.html">
  <link rel="alternate" type="application/rss+xml" title="Ollie's Universe" href="http://www.frolovs.me/feed.xml">

  
  

  
  
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
  
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Ollie's Universe</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Binomial Pricing Trees in R</h1>
    <p class="post-meta"><time datetime="2016-05-26T00:00:00+01:00" itemprop="datePublished">May 26, 2016</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>This is <strong>not</strong> yet another tutorial on binomial trees. I expect my reader to be familiar with them already. If not, an <a href="http://www.goddardconsulting.ca/option-pricing-binomial-index.html">article by Goddard Consulting</a> is rather readable. Here I would like to show how to program the binomial trees in R and how to generate the graph description which an external program like <a href="http://www.graphviz.org/">graphviz</a> can turn into a pretty picture.</p>

<h1 id="why-keep-the-tree">Why keep the tree?</h1>

<p>It is true that in many cases it is not necessary to store the whole tree just to get the final value of the option. I do, however, find it useful to see how the option value changes with the asset price and time. It is also useful if one wishes to calculate greeks, for example.</p>

<h1 id="some-examples">Some examples</h1>

<p>The following example was produced by the programs discussed later in this post. The parameters (and, thankfully, results) match those of the Example 11.11 in Hull.</p>

<blockquote>
  <p>The index level is 810, strike price is 800, risk-free rate is 5%, volatility is 20%, and dividend yield is 2%. We are pricing a 6-month European call option.</p>
</blockquote>

<p><img src="/assets/binomial-tree-european-call-1.png" alt="A Binomial Tree Example 1" /></p>

<p>For a more involved example, here is a valuation of an American put with more steps. The circumscribed noded at the bottom right are the nodes where an early exercise is preferred.</p>

<p><img src="/assets/binomial-tree-american-put-1.png" alt="A Binomial Tree Example 2" /></p>

<p>By comparing with the following screenshot from DerivaGem one can see that the values make sense, indeed.</p>

<p><img src="/assets/derivagem-1.png" alt="A DerivaGem screenshot" /></p>

<p>That’s the desired outcome, let’s get it done.</p>

<h1 id="previously-in-2012">Previously… in 2012</h1>

<p>The <a href="http://www.theresearchkitchen.com/archives/738">two functions written by Rory Winston</a> will provide scaffolding for achieving the aims of this post.</p>

<p>The <em>genlattice</em> function generates the <em>recombining binomial tree</em>, or <em>binary lattice</em> for the asset price only.</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/1246bdc97e26e9b4ac0712f53fa1eaa9.js"> </script>

<p>The <em>dotlattice</em> function takes this lattice and generates the graph specification in <a href="http://www.graphviz.org/">graphviz</a> format from it.</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/0818526077ab518317cdaac7d7f148ab.js"> </script>

<p>These two functions are our starting point.</p>

<h1 id="fast-forward-to-2016">Fast forward to 2016</h1>

<p>Rory’s post was written in 2012, and I had to make some trivial changes to make it work with my version of <a href="http://www.graphviz.org/">graphviz</a>. Specifically, I had to remove references to <em>samehead</em> and <em>sametail</em> in node specification.</p>

<p>I changed the line</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">cat</span><span class="p">(</span><span class="s2">"node[shape="</span><span class="p">,</span><span class="n">shape</span><span class="p">,</span><span class="s2">", samehead, sametail];"</span><span class="p">,</span><span class="s2">"\n"</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">""</span><span class="p">)</span></code></pre></figure>

<p>to</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">cat</span><span class="p">(</span><span class="s2">"node[shape="</span><span class="p">,</span><span class="n">shape</span><span class="p">,</span><span class="s2">"];"</span><span class="p">,</span><span class="s2">"\n"</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">""</span><span class="p">)</span></code></pre></figure>

<p>and this was enough to be able to produce the image using R</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="o">&gt;</span> <span class="n">x</span> <span class="o">&lt;-</span> <span class="n">capture.output</span><span class="p">(</span><span class="n">dotlattice</span><span class="p">(</span><span class="n">genlattice</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="m">8</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="m">1.1</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="m">0.9</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="n">TRUE</span><span class="p">))</span>
<span class="o">&gt;</span> <span class="n">cat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">"lattice.dot"</span><span class="p">)</span></code></pre></figure>

<p>and the terminal</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">$ </span>dot -Tpng -o lattice-1.png lattice.dot</code></pre></figure>

<p><img src="/assets/lattice-1.png" alt="A Binomial Tree generated with genlattice and dotlattice. " /></p>

<p>These functions are a good starting point but we need more. The <em>genlattice</em> function must value the option and store the option price, as well as the asset price. It must accept the parameters which describe the option valuation scenarios, such as volatility, interest rates, payoff function and so on. The <em>dotlattice</em> function needs to render both asset and option prices to a desired level of precision. It must work with both European and American trees (the latter is different from the former by having an early exercise flag for each node).</p>

<h1 id="the-vanilla-payoff-functions">The Vanilla Payoff Functions</h1>

<p>We must have the payoff functions in hand before we proceed. These provide the boundary conditions for the equations and they will be useful for pricing both European and American options. Note, that these are <em>vanilla</em> options only for now.</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/44f66fde5719348946b121f91204caef.js"> </script>

<h1 id="european-option-valuation">European Option Valuation</h1>

<p>I make a number of significant changes to <em>genlattice</em> function. Previously, we’ve been storing the asset value only at each node using a vector named <em>X</em>. Now we are going to store <em>two</em> values per node – the asset price and the option price. This can be achieved by using a data frame. To create a data frame, we first compute the number of nodes in the tree and pre-populate the frame with NA values. This is to make sure that our pricing algorithm does not leave any nodes untouched. This provides an invariant – after the valuation has finished, there should be no NA values in the frame.</p>

<p>We also need to match the up and down movement parameters with volatility since the latter is the thing we can at least hope to know. For this, the oldest and simplest Cox-Ross-Rubinstein method is used (CRR, 1979), where the <script type="math/tex">\sigma</script> is volatility and <script type="math/tex">\delta t</script> is a time step.</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align}
  u& =e^{\sigma \sqrt{\delta t}}\\
  d& =e^{-\sigma \sqrt{\delta t}} = \frac{1}{u}\\
  p& =\frac{a - d}{u - d}\\
  a& = e^{-r \delta t}
\end{align} %]]></script>

<p>Where <script type="math/tex">p</script> is the synthetic probability (or Q-measure).</p>

<p>Aplying the discussed changes results in the following function.</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/177e8b41c5829cce4a4b0d4d219bf99d.js"> </script>

<p>For convenience, I also define two functions which will serve as the interface to it.</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/80dd9ef9a39a83719550cd7750733dc5.js"> </script>

<h1 id="american-option-valuation">American Option Valuation</h1>

<p>For the American option, the early exercise flag must to be stored at every node as well. While it’s possible to have a unified implementation which values both European and American options, the amount of branching resulting in the code is not worth it, in my experience. The extra flags and branching sabotage clarity and ease of making changes. I take the view that any computer program that handles money must be as straightforward in its implementation as possible. So, without further ado, I present my American vanilla option valuator.</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/72779161c6bced858b73867074de27b1.js"> </script>

<p>And just like before, there are two functions which will serve as the interface to it.</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/29f873631bd014af2d2d9262a4a79080.js"> </script>

<h1 id="plotting-the-tree">Plotting the tree</h1>

<p>Thankfully, as far as plotting is concerned, the differences between a European and American trees are negligible – the latter needs some way of highlighting the nodes where early exercise happens. So I chose to keep a single <em>dotlattice</em> implementation which checks which type of tree it is dealing with. The facility to round the prices to a given number of digits after a decimal point has been introduced. I have also removed some unnecessary functionality such as printing the points instead of full nodes.</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/0338553b084a447142717bee62f0324a.js"> </script>

<h1 id="the-results">The results</h1>

<p>Now the time has come to try some examples. Here is the <a href="https://github.com/olliefr/binomial-trees/blob/master/binomial-pricing-trees.R">complete, up-to-date code in a single file</a>.</p>

<p>The first example is the European Call that we have seen in the introduction albeit with an increased number of steps.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="o">&gt;</span> <span class="n">x</span> <span class="o">&lt;-</span> <span class="n">genlattice.vanilla.european.call</span><span class="p">(</span><span class="n">Asset</span><span class="o">=</span><span class="m">810</span><span class="p">,</span> <span class="n">Volatility</span><span class="o">=</span><span class="m">0.2</span><span class="p">,</span> <span class="n">IntRate</span><span class="o">=</span><span class="m">0.05</span><span class="p">,</span> <span class="n">DividendRate</span><span class="o">=</span><span class="m">0.02</span><span class="p">,</span> <span class="n">Strike</span><span class="o">=</span><span class="m">800</span><span class="p">,</span> <span class="n">Expiry</span><span class="o">=</span><span class="m">0.5</span><span class="p">,</span> <span class="n">NoSteps</span><span class="o">=</span><span class="m">5</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">y</span> <span class="o">&lt;-</span> <span class="n">capture.output</span><span class="p">(</span><span class="n">dotlattice</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="m">4</span><span class="p">))</span>
<span class="o">&gt;</span> <span class="n">cat</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">"lattice.dot"</span><span class="p">)</span></code></pre></figure>

<p>And through the <a href="http://www.graphviz.org/">graphviz</a>.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">$ </span>dot -Tpng -o binomial-tree-european-call-2.png lattice.dot</code></pre></figure>

<p>The output is</p>

<p><img src="/assets/binomial-tree-european-call-2.png" alt="A Binomial Tree Example 3" /></p>

<p>Another example is for a foreign currency, which can be thought of as an asset providing a yield at the foreign risk-free rate of interest.</p>

<p>The following Example 11.2 is from Hull 7th ed., p. 254</p>

<blockquote>
  <p>The Australian dollar is currently worth 0.6100 U.S. dollards and this exchange rate has a volatility of 12%. The Australian risk-free rate is 7% and the U.S. risk-free rate is 5%. […] 3-month American call option with a strike price of 0.6000 using a three-step tree.</p>
</blockquote>

<p>We can value this using our framework</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="o">&gt;</span> <span class="n">x</span> <span class="o">&lt;-</span> <span class="n">genlattice.vanilla.american.call</span><span class="p">(</span><span class="n">Asset</span> <span class="o">=</span> <span class="m">0.6100</span><span class="p">,</span> <span class="n">Volatility</span> <span class="o">=</span> <span class="m">0.12</span><span class="p">,</span> <span class="n">IntRate</span> <span class="o">=</span> <span class="m">0.05</span><span class="p">,</span> <span class="n">DividendRate</span> <span class="o">=</span> <span class="m">0.07</span><span class="p">,</span> <span class="n">Strike</span> <span class="o">=</span> <span class="m">0.6</span><span class="p">,</span> <span class="n">Expiry</span> <span class="o">=</span> <span class="m">3</span><span class="o">/</span><span class="m">12</span><span class="p">,</span> <span class="n">NoSteps</span> <span class="o">=</span> <span class="m">3</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">y</span> <span class="o">&lt;-</span> <span class="n">capture.output</span><span class="p">(</span><span class="n">dotlattice</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="m">3</span><span class="p">))</span>
<span class="o">&gt;</span> <span class="n">cat</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">"lattice.dot"</span><span class="p">)</span></code></pre></figure>

<p>And through the <a href="http://www.graphviz.org/">graphviz</a>.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">$ </span>dot -Tpng -o binomial-tree-american-call-1.png lattice.dot</code></pre></figure>

<p>We get</p>

<p><img src="/assets/binomial-tree-american-call-1.png" alt="A Binomial Tree Example 4" /></p>

<p>This matches the Figure 11.12 in Hull. What a relief!</p>

<h1 id="what-now">What now?</h1>

<p>The code that we now have opens up a number of interesting directions. The other related things which I would like to try:</p>

<ul>
  <li>Computing the Greeks in binomial tree</li>
  <li>Binomial trees with skewness and curtosis</li>
  <li>Matching volatility with methods other than Cox-Ross-Rubinstein</li>
  <li>Trinomial trees</li>
  <li>Non-recombining trees, path-dependent options</li>
  <li>Power, cap options</li>
</ul>

<p>I’ll post a write-up if I ever have the chance to look into them.</p>

<h1 id="references">References</h1>

<p>The books listed below all discuss binomial trees to some depth and have pictures like the ones I have created for this post.</p>

<ul>
  <li>Haug, E.G. (2007) <em>The Complete Guide to Option Pricing Formulas</em>. 2nd ed. Mc-Graw Hill</li>
  <li>Hull, J.C. (2007) <em>Options, Futures, and Other Derivatives</em>. 7th ed. Pearson Education</li>
  <li>Neftci, S.N. and Hirsa A. (2014) <em>An Introduction to the Mathematics of Financial Derivatives</em>. 3rd ed. Elsevier</li>
  <li>Wilmott, P. (2006) <em>Paul Wilmott on Quantitative Finance: Volume 1</em>. 2nd ed. Wiley</li>
</ul>


  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Ollie's Universe</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
	  <li>Get in touch:</li>
          <li><a href="mailto:webpage@frolovs.me">webpage@frolovs.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/olliefr"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">olliefr</span></a>

          </li>
          

          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>&ldquo;<em>Ollie's website!</em>&rdquo; the Gruffalo said,<br> And quick as the wind he turned and fled.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
